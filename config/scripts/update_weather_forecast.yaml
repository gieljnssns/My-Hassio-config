update_weather_forecast:
  alias: "Update weather forecast"
  icon: mdi:cloud-alert
  fields:
    forecast_type:
      description: "Enter the targets in case they are not clear from the service calls"
      required: false
      selector:
        select:
          options:
            - daily
            - hourly
            - twice_daily
  sequence:
    - event: update_forecast_data
      event_data:
        type: "{{ forecast_type }}"
        action: remove
    - delay: 0.5
    - repeat:
        for_each: "{{ states.weather | map(attribute='entity_id') | reject('search', 'combined') | list }}"
        sequence:
          - service: weather.get_forecast
            data:
              type: "{{ forecast_type }}"
            target:
              entity_id: "{{ repeat.item }}"
            continue_on_error: true
            response_variable: forecast
          - if: "{{ forecast is defined }}"
            then:
              - event: update_forecast_data
                event_data:
                  type: "{{ forecast_type }}"
                  action: update
                  provider: "{{ repeat.item }}"
                  forecast: "{{ forecast.forecast if forecast is defined else [] }}"
          - delay: 0.5
