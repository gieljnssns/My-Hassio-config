- sensor:
    - name: "Wasmachien uren"
      unique_id: c7278411-c766-4fcd-81ea-0604db1b1f76
      unit_of_measurement: "uur"
      state: >
        {% if states("input_boolean.wasmachien_starten") == 'on' %}
          {% if states("switch.wasmachien") == 'off' %}
            2
          {% elif states("input_boolean.emhass_wasmachien") == 'on' %}
            {% if (2 - ((as_timestamp(now()) - states("sensor.wasmachien_is_gestart_op") | float(0)) / 3600) | round(1)) | float(0) > 0  %}
              {{ 2 - ((as_timestamp(now()) - states("sensor.wasmachien_is_gestart_op") | float(0)) / 3600) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}

    - name: "Droogkast uren"
      unique_id: 59e14f81-ccd8-4099-b08d-d21c53ff3c70
      unit_of_measurement: "uur"
      state: >
        {% if states("input_boolean.droogkast_starten") == 'on' %}
          {% if states("switch.droogkast") == 'off' and states("input_boolean.wasmachien_starten") == 'on' and states("input_boolean.afwasmachien_starten") == 'on' %}
            6
          {% elif states("switch.droogkast") == 'off' and states("input_boolean.wasmachien_starten") == 'on' %}
            4
          {% elif states("switch.droogkast") == 'off' and states("input_boolean.afwasmachien_starten") == 'on' %}
            4
          {% elif states("switch.droogkast") == 'off' %}
            2
          {% elif states("input_boolean.emhass_droogkast") == 'on'%}
            {% if (2 - ((as_timestamp(now()) - states("sensor.droogkast_is_gestart_op") | float(0)) / 3600) | round(1)) | float(0) > 0  %}
              {{ 2 - ((as_timestamp(now()) - states("sensor.droogkast_is_gestart_op") | float(0)) / 3600) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}

    - name: "Afwasmachien uren"
      unique_id: 062928fa-46a0-407c-9947-085b5278ec96
      unit_of_measurement: "uur"
      state: >
        {% if states("input_boolean.afwasmachien_starten") == 'on'%}
          {% if states("switch.afwasmachien") == 'off'%}
            2.5
          {% elif states("input_boolean.emhass_afwasmachien") == 'on'%}
            {% if (2.5 - ((as_timestamp(now()) - states("sensor.afwasmachien_is_gestart_op") | float(0)) / 3600) | round(1)) | float(0) > 0  %}
              {{ 2.5 - ((as_timestamp(now()) - states("sensor.afwasmachien_is_gestart_op") | float(0)) / 3600) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}

    - name: Warmtepompboiler uren
      unique_id: 8225bcd3-62ca-40af-8891-ba06a95eed91
      unit_of_measurement: "uur"
      availability: >-
        {{ states("switch.warm_water") and 
          states("input_boolean.warm_water_starten") and
          states("input_boolean.op_verlof") and
          states("sensor.thermostaat") and
          states("binary_sensor.warmtepompboiler_aan") and
          states("sensor.warmtepompboiler_is_gestart_op")
          not in ["unknown", "unavailable", "none"] 
          and states("sensor.thermostaat") is string }}
      state: >
        {% if states("input_boolean.op_verlof") == 'off' %}
          {% if states("input_boolean.warm_water_starten") == 'on' %}
            {% if states("switch.warm_water") == 'on' and states("binary_sensor.warmtepompboiler_aan") == 'off' %}
              {{ ((49 - (states("sensor.thermostaat") | float(0))) / 2.5) | round(1)  }}
            {% elif (as_timestamp(now()) - states("sensor.warmtepompboiler_is_gestart_op") | float(0)) < 3600 %}
              {{ ((49 - (states("sensor.thermostaat") | float(0))) / 2.5) | round(1)  }}
            {% elif states("binary_sensor.warmtepompboiler_aan") == 'on' %}
              {{ ((49 - (states("sensor.thermostaat") | float(0))) / 3) | round(1)  }}
            {% else %}
              {{ ((49 - (states("sensor.thermostaat") | float(0))) / 2.5) | round(1)  }}
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% else %}
          {% if states("input_boolean.warm_water_starten") == 'on' %}
            {% if states("switch.warm_water") == 'on' and states("binary_sensor.warmtepompboiler_aan") == 'off' %}
              {{ ((46 - (states("sensor.thermostaat") | float(0))) / 2.5) | round(1)  }}
            {% elif (as_timestamp(now()) - states("sensor.warmtepompboiler_is_gestart_op") | float(0)) < 3600 %}
              {{ ((46 - (states("sensor.thermostaat") | float(0))) / 2.5) | round(1)  }}
            {% elif states("binary_sensor.warmtepompboiler_aan") == 'on' %}
              {{ ((46 - (states("sensor.thermostaat") | float(0))) / 3) | round(1)  }}
            {% else %}
              {{ ((46 - (states("sensor.thermostaat") | float(0))) / 2.5) | round(1)  }}
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% endif %}

    - name: Pv power forecast list
      unique_id: 6bc0c511-9c6f-4778-b13e-a20e3646a7e5
      state: >
        {{ states("sensor.solcast_forecast_today")}}
      availability: >-
        {{ states("sensor.solcast_forecast_today")
          not in ["unknown", "unavailable", "none"] }}
      attributes:
        list: >
          {{  (state_attr('sensor.solcast_forecast_today', 'detailedForecast')
                |selectattr('period_start','gt',utcnow())
                |map(attribute='pv_estimate')
                |map('multiply',2000)
                |map('int')
                |list
            + state_attr('sensor.solcast_forecast_tomorrow', 'detailedForecast')
                |selectattr('period_start','gt',utcnow())
                |map(attribute='pv_estimate')
                |map('multiply',2000)
                |map('int')
                |list)[:36]
                }}
    - name: Prod price forecast list
      unique_id: c081ad21-6e07-4346-82e3-d392b4a251d6
      state: >
        {{ states("sensor.solcast_forecast_today")}}
      availability: >-
        {{ states("sensor.solcast_forecast_today")
          not in ["unknown", "unavailable", "none"] }}
      attributes:
        list: >
          {%- set list =  (state_attr('sensor.solcast_forecast_today', 'detailedForecast')
               |selectattr('period_start','gt',utcnow())
               |map(attribute='period_start')
               |list
           + state_attr('sensor.solcast_forecast_tomorrow', 'detailedForecast')
               |selectattr('period_start','gt',utcnow())
               |map(attribute='period_start')
               |list)[:36]
               -%}
          {%- set new_list = namespace(all=[]) %}
          {%- for i in range (list | length) %}
            {%- set hour = (list[i].hour) | int%}
            {%- if hour in [13, 14, 15, 16, 17, 18] %}
              {%- set new_list.all = new_list.all + [ 0.11 ] %}
            {%- else %}
              {%- set new_list.all = new_list.all + [ 0 ] %}
            {%- endif %}
          {%- endfor %}
          {{ (new_list.all)[:36]}}
    # - name: Pv power forecast list length
    #   unique_id: 6eef6afa-9323-4b46-a043-7a11aff86f2d
    #   state: >
    #     {{  (state_attr('sensor.solcast_forecast_today', 'detailedForecast')
    #             |selectattr('period_start','gt',utcnow())
    #             |map(attribute='pv_estimate')
    #             |map('multiply',2000)
    #             |map('int')
    #             |list) | length
    #             }}
    # state: >
    #   {{  ((state_attr('sensor.solcast_forecast_today', 'detailedForecast')
    #           |selectattr('period_start','gt',utcnow())
    #           |map(attribute='pv_estimate')
    #           |map('multiply',2000)
    #           |map('int')
    #           |list
    #       + state_attr('sensor.solcast_forecast_tomorrow', 'detailedForecast')
    #           |selectattr('period_start','gt',utcnow())
    #           |map(attribute='pv_estimate')
    #           |map('multiply',2000)
    #           |map('int')
    #           |list)[:48]) | length
    #           }}
