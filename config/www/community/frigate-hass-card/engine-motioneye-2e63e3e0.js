import{dJ as e,l as t,d7 as a,dM as s,i as n,dT as i,dU as r,dL as o,dK as c,d1 as d,dj as l,dk as u,dV as m,dW as h,dN as g,dX as y,c_ as _,dP as p,dQ as M,dR as w,dY as f,d6 as D,d8 as C}from"./card-fe58fbb1.js";import{C as v,G as E}from"./engine-generic-1ed87f63.js";import{a as b,V as T}from"./media-c9012082.js";import{C as x}from"./engine-86b0096c.js";import{p as S}from"./parse-15d7e868.js";import{e as F}from"./endOfDay-5a88c520.js";class I extends v{constructor(){super(...arguments),this._entity=null}async initialize(a){const s=this.getConfig(),n=s.camera_entity?await a.entityRegistryManager.getEntity(a.hass,s.camera_entity):null;if(!n||!s.camera_entity)throw new e(t("error.no_camera_entity"),s);return this._entity=n,this}getEntity(){return this._entity}}class R extends b{constructor(e,t,s){super(e,t),this._browseMedia=s,s._metadata?.startDate?this._id=`${t}/${a(s._metadata.startDate,"yyyy-MM-dd HH:mm:ss")}`:this._id=s.media_content_id}getStartTime(){return this._browseMedia._metadata?.startDate??null}getEndTime(){return null}getVideoContentType(){return T.MP4}getID(){return this._id}getContentID(){return this._browseMedia.media_content_id}getTitle(){const e=this.getStartTime();return e?s(e):this._browseMedia.title}getThumbnail(){return this._browseMedia.thumbnail}getWhat(){return null}getScore(){return null}getTags(){return null}isGroupableWith(e){return this.getMediaType()===e.getMediaType()&&n(this.getWhere(),e.getWhere())&&n(this.getWhat(),e.getWhat())}}class W{static createEventViewMedia(e,t,a){return new R(e,a,t)}}const z=(e,t,a)=>{const s=t??a;return!s||!!e._metadata&&h({start:e._metadata.startDate,end:e._metadata.endDate},{start:t??s,end:a??s})};class G extends E{constructor(e,t,a,s,n,i){super(t,i),this._entityRegistryManager=e,this._browseMediaManager=a,this._resolvedMediaCache=s,this._requestCache=n}async createCamera(e,t){const a=new I(t,this,{capabilities:new o({"favorite-events":!1,"favorite-recordings":!1,clips:!0,live:!0,menu:!0,recordings:!1,seek:!1,snapshots:!0,substream:!0,ptz:c(t)??void 0},{disable:t.capabilities?.disable,disableExcept:t.capabilities?.disable_except}),eventCallback:this._eventCallback});return await a.initialize({entityRegistryManager:this._entityRegistryManager,hass:e,stateWatcher:this._stateWatcher})}generateDefaultEventQuery(e,t,a){return[{type:d.Event,cameraIDs:t,...a}]}async getMediaDownloadPath(e,t,a){const s=a.getContentID();if(!s)return null;const n=await l(e,s,this._resolvedMediaCache);return n?{endpoint:u(e,n.url)}:null}getQueryResultMaxAge(e){return e.type===d.Event?m:null}getMediaCapabilities(e){return{canFavorite:!1,canDownload:!0}}}class j{static isMotionEyeEventQueryResults(e){return e.engine===g.MotionEye&&e.type===M.Event}}const q={"%Y":"yyyy","%m":"MM","%d":"dd","%H":"HH","%M":"mm","%S":"ss"},$=new RegExp(/(%Y|%m|%d|%H|%M|%S)/g);class k extends G{getEngineType(){return g.MotionEye}_convertMotionEyeTimeFormatToDateFNS(e){return e.replace($,((e,t)=>q[t]))}_motionEyeMetadataGeneratorFile(e,t,a,s){let n=s?._metadata?.startDate??new Date;if(t){const e=a.title.replace(/\.[^/.]+$/,"");if(n=S(e,t,n),!y(n))return null}return{cameraID:e,startDate:n,endDate:n}}_motionEyeMetadataGeneratorDirectory(e,t,a,s){let n=s?._metadata?.startDate??new Date;if(t){const e=S(a.title,t,n);if(!y(e))return null;n=_(e)}return{cameraID:e,startDate:n,endDate:s?._metadata?.endDate??F(n)}}async _getMatchingDirectories(e,t,a,s,n){const i=t.getCamera(a),r=i?.getConfig();if(!(i instanceof I&&r))return null;const o=i.getEntity(),c=o?.config_entry_id,d=o?.device_id;if(!c||!d)return null;const l=(e,t)=>{const n=e.shift();if(!n)return[];const i=n.includes("%")?this._convertMotionEyeTimeFormatToDateFNS(n):null;return[{targets:t,metadataGenerator:(e,t)=>this._motionEyeMetadataGeneratorDirectory(a,i,e,t),matcher:e=>e.can_expand&&(!!i||e.title===n)&&z(e,s?.start,s?.end),advance:t=>l(e,t)}]};return await this._browseMediaManager.walkBrowseMedias(e,[...!1===s?.hasClip||s?.hasSnapshot?[]:l(r.motioneye.movies.directory_pattern.split("/"),[`media-source://motioneye/${c}#${d}#movies`]),...!1===s?.hasSnapshot||s?.hasClip?[]:l(r.motioneye.images.directory_pattern.split("/"),[`media-source://motioneye/${c}#${d}#images`])],{useCache:n?.useCache})}async getEvents(e,t,a,s){if(a.favorite||a.tags?.size||a.what?.size||a.where?.size)return null;const n=new Map,o=async o=>{const c={...a,cameraIDs:new Set([o])},d=s?.useCache??1?this._requestCache.get(c):null;if(d)return void n.set(c,d);const l=t.getCameraConfig(o);if(!l)return;const u=await this._getMatchingDirectories(e,t,o,c,s);if(!u||!u.length)return;const m=this._convertMotionEyeTimeFormatToDateFNS(l.motioneye.movies.file_pattern),h=this._convertMotionEyeTimeFormatToDateFNS(l.motioneye.images.file_pattern),y=await this._browseMediaManager.walkBrowseMedias(e,[{targets:u,metadataGenerator:(e,t)=>e.media_class===r||e.media_class===i?this._motionEyeMetadataGeneratorFile(o,e.media_class===r?h:m,e,t):null,matcher:e=>!e.can_expand&&z(e,c.start,c.end)}],{useCache:s?.useCache}),_=D(y,(e=>e._metadata?.startDate),"desc").slice(0,c.limit??x),p={type:M.Event,engine:g.MotionEye,browseMedia:_};(s?.useCache??1)&&this._requestCache.set(c,{...p,cached:!0},p.expiry),n.set(c,p)};return await p(a.cameraIDs,(e=>o(e))),n.size?n:null}generateMediaFromEvents(e,t,a,s){return j.isMotionEyeEventQueryResults(s)?(e=>{const t=new Map;for(const a of e){const e=a._metadata?.cameraID;if(!e)continue;const s=a.media_class===i?"clip":a.media_class===r?"snapshot":null;if(!s)continue;const n=W.createEventViewMedia(s,a,e);if(n){const e=n.getID(),a=t.get(e);(!a||"snapshot"===a.getMediaType()&&"clip"===n.getMediaType())&&t.set(e,n)}}return[...t.values()]})(s.browseMedia):null}async getMediaMetadata(e,t,a,s){const n=new Map;if((s?.useCache??1)&&this._requestCache.has(a)){const e=this._requestCache.get(a);if(e)return n.set(a,e),n}const i=new Set,r=async a=>{const n=await this._getMatchingDirectories(e,t,a,null,s);for(const e of n??[])e._metadata&&i.add(C(e._metadata?.startDate))};await p(a.cameraIDs,(e=>r(e)));const o={type:M.MediaMetadata,engine:g.MotionEye,metadata:{...i.size&&{days:i}},expiry:w(new Date,{seconds:m}),cached:!1};return(s?.useCache??1)&&this._requestCache.set(a,{...o,cached:!0},o.expiry),n.set(a,o),n}getCameraMetadata(e,t){return{...super.getCameraMetadata(e,t),engineLogo:f}}getCameraEndpoints(e,t){const a=e.motioneye?.url?{endpoint:e.motioneye.url}:null;return{...super.getCameraEndpoints(e,t),...a&&{ui:a}}}}export{k as MotionEyeCameraManagerEngine};
