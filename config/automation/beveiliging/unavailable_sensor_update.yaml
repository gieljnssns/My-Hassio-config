id: "1596733904625"
alias: Unavailable entities sensor update
description: ""
trigger:
  - platform: time_pattern
    minutes: /5
condition:
  - condition: template
    value_template: "{{ states('sensor.uptime_in_uren')|float > 0.05|float }}"
action:
  - variables:
      entity_ids: |-
        {{ states   
          | selectattr('state','in',['unavailable','unknown','none'])
          | rejectattr('entity_id','in',state_attr('group.ignored_entities', 'entity_id'))
          | rejectattr('domain','eq','group')
          | map(attribute='entity_id')
          | list
          | join(',')
        }}
      names: |-
        {% set ns = namespace(names=[]) %}

        {% for dev in entity_ids.split(',') %}
          {% set ns.names = ns.names + [state_attr(dev, 'friendly_name')] %}
        {% endfor %}

        {{ ns.names | to_json }}
      num: '{{ entity_ids.split(",") | length - 1 }}'
  - service: mqtt.publish
    data:
      topic: homeassistant/unavailable_entities
      payload: |-
        {
          "num": {{ num }},
          "names": {{ names }},
          "entity_ids": {{ entity_ids.split(',') | to_json }}
        }
